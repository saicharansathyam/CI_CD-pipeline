name: Release
on:
  push:
    tags: ['v*']          # e.g., v0.1.3
  workflow_dispatch: {}

permissions:
  contents: write         # needed to publish the release

env:
  TAG: ${{ github.ref_name }}

jobs:
  build-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (with tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Qt & tooling (APT)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qt6-base-dev qt6-declarative-dev qt6-tools-dev qt6-tools-dev-tools \
            qml6-module-qtquick qml6-module-qtquick-window qml6-module-qtquick-controls \
            qml6-module-qtquick-layouts qml6-module-qtqml qml6-module-qttest \
            qml6-module-qtqml-workerscript \
            libxkbcommon-dev libgl1-mesa-dev libx11-dev libxext-dev libvulkan-dev \
            patchelf squashfs-tools desktop-file-utils wget file imagemagick

      - name: Configure (Release)
        run: cmake -S CI_CD_Test -B CI_CD_Test/build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build CI_CD_Test/build --parallel

      - name: Package raw binary (versioned tar.gz)
        run: |
          tar -czf CI_CD_Test/build/HeadUnitApp-${TAG}-linux-x64.tar.gz \
            -C CI_CD_Test/build/src HeadUnitApp

      - name: Make AppImage
        run: |
          set -e
          BIN="CI_CD_Test/build/src/HeadUnitApp"
          APPDIR="appdir"
          ICON="$APPDIR/usr/share/icons/hicolor/256x256/apps/headunitapp.png"
          DESKTOP="$APPDIR/usr/share/applications/headunitapp.desktop"

          mkdir -p "$APPDIR/usr/bin" "$(dirname "$ICON")" "$(dirname "$DESKTOP")"
          cp "$BIN" "$APPDIR/usr/bin/HeadUnitApp"

          # Minimal desktop file
          cat > "$DESKTOP" <<'EOF'
          [Desktop Entry]
          Type=Application
          Name=HeadUnitApp
          Exec=HeadUnitApp
          Icon=headunitapp
          Categories=Utility;
          EOF

          # Create a valid 256x256 PNG icon with ImageMagick
          # Try modern 'magick', fallback to 'convert' if needed
          if command -v magick >/dev/null 2>&1; then
            magick -size 256x256 canvas:none -fill "#4a90e2" \
              -draw "roundrectangle 16,16 240,240 48,48" "$ICON"
          else
            convert -size 256x256 xc:#4a90e2 "$ICON"
          fi

          # Fetch linuxdeploy + Qt plugin
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy-*.AppImage

          # Help the Qt plugin find your QML sources for bundling
          export QML_SOURCES_PATHS="CI_CD_Test/src/qml"

          # Build AppImage (Qt plugin auto-bundles Qt/QML)
          ./linuxdeploy-x86_64.AppImage --appdir "$APPDIR" \
            -e "$APPDIR/usr/bin/HeadUnitApp" \
            -d "$DESKTOP" \
            -i "$ICON" \
            --plugin qt --output appimage

          # Move artifact with versioned name
          APPIMAGE="$(ls -1 *.AppImage | head -n1)"
          mv "$APPIMAGE" "CI_CD_Test/build/HeadUnitApp-${TAG}-x86_64.AppImage"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            CI_CD_Test/build/HeadUnitApp-${{ env.TAG }}-linux-x64.tar.gz
            CI_CD_Test/build/HeadUnitApp-${{ env.TAG }}-x86_64.AppImage
          generate_release_notes: true
